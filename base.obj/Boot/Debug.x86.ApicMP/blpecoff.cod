; Listing generated by Microsoft (R) Optimizing Compiler Version 14.00.50727.762 

	TITLE	C:\Users\cc\source\repos\Singularity-OS\base\Boot\SingLdrPc\blpecoff.cpp
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@		; `string'
PUBLIC	??_C@_0BI@DNDJLEKB@PECOFF?3?5Invalid?5image?$CB?6?$AA@ ; `string'
PUBLIC	?BlPeGetVirtualRange@@YIXPAXPAPAXPAK@Z		; BlPeGetVirtualRange
EXTRN	?BlRtlHaltInternal@@YIXPBDK@Z:PROC		; BlRtlHaltInternal
EXTRN	?BlRtlPrintf@@YAEPBDZZ:PROC			; BlRtlPrintf
;	COMDAT ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
; File c:\users\cc\source\repos\singularity-os\base\boot\singldrpc\blpecoff.cpp
CONST	SEGMENT
??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@ DB 'blpecoff.cpp', 00H ; `string'
CONST	ENDS
;	COMDAT ??_C@_0BI@DNDJLEKB@PECOFF?3?5Invalid?5image?$CB?6?$AA@
CONST	SEGMENT
??_C@_0BI@DNDJLEKB@PECOFF?3?5Invalid?5image?$CB?6?$AA@ DB 'PECOFF: Invali'
	DB	'd image!', 0aH, 00H				; `string'
; Function compile flags: /Odsp
CONST	ENDS
;	COMDAT ?BlPeGetVirtualRange@@YIXPAXPAPAXPAK@Z
_TEXT	SEGMENT
_VirtualBase$ = -28					; size = 4
_Image$ = -24						; size = 4
_SectionEnd$ = -20					; size = 4
_DosHeader$ = -16					; size = 4
_Index$ = -12						; size = 4
_NtHeader$ = -8						; size = 4
_Section$ = -4						; size = 4
_VirtualSize$ = 8					; size = 4
?BlPeGetVirtualRange@@YIXPAXPAPAXPAK@Z PROC		; BlPeGetVirtualRange, COMDAT
; _Image$ = ecx
; _VirtualBase$ = edx

; 202  : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 1c	 sub	 esp, 28			; 0000001cH
  00006	89 55 e4	 mov	 DWORD PTR _VirtualBase$[ebp], edx
  00009	89 4d e8	 mov	 DWORD PTR _Image$[ebp], ecx

; 203  :     PIMAGE_DOS_HEADER DosHeader;
; 204  :     UINT32 Index;
; 205  :     PIMAGE_NT_HEADERS NtHeader;
; 206  :     PIMAGE_SECTION_HEADER Section;
; 207  :     UINT32 SectionEnd;
; 208  : 
; 209  :     DosHeader = (PIMAGE_DOS_HEADER) Image;

  0000c	8b 45 e8	 mov	 eax, DWORD PTR _Image$[ebp]
  0000f	89 45 f0	 mov	 DWORD PTR _DosHeader$[ebp], eax

; 210  : 
; 211  :     if (DosHeader->e_magic != IMAGE_DOS_SIGNATURE) {

  00012	8b 45 f0	 mov	 eax, DWORD PTR _DosHeader$[ebp]
  00015	0f b7 00	 movzx	 eax, WORD PTR [eax]
  00018	3d 4d 5a 00 00	 cmp	 eax, 23117		; 00005a4dH
  0001d	74 1a		 je	 SHORT $LN8@BlPeGetVir

; 212  : 
; 213  :         BlRtlPrintf("PECOFF: Invalid image!\n");

  0001f	68 00 00 00 00	 push	 OFFSET ??_C@_0BI@DNDJLEKB@PECOFF?3?5Invalid?5image?$CB?6?$AA@
  00024	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  00029	59		 pop	 ecx

; 214  :         BlRtlHalt();

  0002a	ba d6 00 00 00	 mov	 edx, 214		; 000000d6H
  0002f	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  00034	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN8@BlPeGetVir:

; 215  :     }
; 216  : 
; 217  :     NtHeader = (PIMAGE_NT_HEADERS) ((ULONG_PTR) Image + DosHeader->e_lfanew);

  00039	8b 45 f0	 mov	 eax, DWORD PTR _DosHeader$[ebp]
  0003c	8b 4d e8	 mov	 ecx, DWORD PTR _Image$[ebp]
  0003f	03 48 3c	 add	 ecx, DWORD PTR [eax+60]
  00042	89 4d f8	 mov	 DWORD PTR _NtHeader$[ebp], ecx

; 218  : 
; 219  :     if (NtHeader->Signature != IMAGE_NT_SIGNATURE) {

  00045	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  00048	81 38 50 45 00
	00		 cmp	 DWORD PTR [eax], 17744	; 00004550H
  0004e	74 1a		 je	 SHORT $LN7@BlPeGetVir

; 220  : 
; 221  :         BlRtlPrintf("PECOFF: Invalid image!\n");

  00050	68 00 00 00 00	 push	 OFFSET ??_C@_0BI@DNDJLEKB@PECOFF?3?5Invalid?5image?$CB?6?$AA@
  00055	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  0005a	59		 pop	 ecx

; 222  :         BlRtlHalt();

  0005b	ba de 00 00 00	 mov	 edx, 222		; 000000deH
  00060	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  00065	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN7@BlPeGetVir:

; 223  :     }
; 224  : 
; 225  :     if (NtHeader->FileHeader.NumberOfSections == 0) {

  0006a	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  0006d	0f b7 40 06	 movzx	 eax, WORD PTR [eax+6]
  00071	85 c0		 test	 eax, eax
  00073	75 1a		 jne	 SHORT $LN6@BlPeGetVir

; 226  : 
; 227  :         BlRtlPrintf("PECOFF: Invalid image!\n");

  00075	68 00 00 00 00	 push	 OFFSET ??_C@_0BI@DNDJLEKB@PECOFF?3?5Invalid?5image?$CB?6?$AA@
  0007a	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  0007f	59		 pop	 ecx

; 228  :         BlRtlHalt();

  00080	ba e4 00 00 00	 mov	 edx, 228		; 000000e4H
  00085	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  0008a	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN6@BlPeGetVir:

; 229  :     }
; 230  : 
; 231  :     if ((NtHeader->OptionalHeader.ImageBase % PAGE_SIZE) != 0) {

  0008f	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  00092	8b 40 34	 mov	 eax, DWORD PTR [eax+52]
  00095	33 d2		 xor	 edx, edx
  00097	b9 00 10 00 00	 mov	 ecx, 4096		; 00001000H
  0009c	f7 f1		 div	 ecx
  0009e	85 d2		 test	 edx, edx
  000a0	74 1a		 je	 SHORT $LN5@BlPeGetVir

; 232  : 
; 233  :         BlRtlPrintf("PECOFF: Invalid image!\n");

  000a2	68 00 00 00 00	 push	 OFFSET ??_C@_0BI@DNDJLEKB@PECOFF?3?5Invalid?5image?$CB?6?$AA@
  000a7	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  000ac	59		 pop	 ecx

; 234  :         BlRtlHalt();

  000ad	ba ea 00 00 00	 mov	 edx, 234		; 000000eaH
  000b2	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  000b7	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN5@BlPeGetVir:

; 235  :     }
; 236  : 
; 237  :     *VirtualBase = (PVOID) NtHeader->OptionalHeader.ImageBase;

  000bc	8b 45 e4	 mov	 eax, DWORD PTR _VirtualBase$[ebp]
  000bf	8b 4d f8	 mov	 ecx, DWORD PTR _NtHeader$[ebp]
  000c2	8b 49 34	 mov	 ecx, DWORD PTR [ecx+52]
  000c5	89 08		 mov	 DWORD PTR [eax], ecx

; 238  :     *VirtualSize = 0;

  000c7	8b 45 08	 mov	 eax, DWORD PTR _VirtualSize$[ebp]
  000ca	83 20 00	 and	 DWORD PTR [eax], 0

; 239  : 
; 240  :     Section = (PIMAGE_SECTION_HEADER) (((ULONG_PTR) &NtHeader->OptionalHeader) + NtHeader->FileHeader.SizeOfOptionalHeader);

  000cd	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  000d0	0f b7 40 14	 movzx	 eax, WORD PTR [eax+20]
  000d4	8b 4d f8	 mov	 ecx, DWORD PTR _NtHeader$[ebp]
  000d7	8d 44 01 18	 lea	 eax, DWORD PTR [ecx+eax+24]
  000db	89 45 fc	 mov	 DWORD PTR _Section$[ebp], eax

; 241  : 
; 242  :     for (Index = 0; Index < NtHeader->FileHeader.NumberOfSections; Index += 1) {

  000de	83 65 f4 00	 and	 DWORD PTR _Index$[ebp], 0
  000e2	eb 07		 jmp	 SHORT $LN4@BlPeGetVir
$LN3@BlPeGetVir:
  000e4	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  000e7	40		 inc	 eax
  000e8	89 45 f4	 mov	 DWORD PTR _Index$[ebp], eax
$LN4@BlPeGetVir:
  000eb	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  000ee	0f b7 40 06	 movzx	 eax, WORD PTR [eax+6]
  000f2	39 45 f4	 cmp	 DWORD PTR _Index$[ebp], eax
  000f5	73 31		 jae	 SHORT $LN2@BlPeGetVir

; 243  : 
; 244  :         SectionEnd = Section[Index].VirtualAddress + Section[Index].Misc.VirtualSize;

  000f7	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  000fa	6b c0 28	 imul	 eax, 40			; 00000028H
  000fd	8b 4d f4	 mov	 ecx, DWORD PTR _Index$[ebp]
  00100	6b c9 28	 imul	 ecx, 40			; 00000028H
  00103	8b 55 fc	 mov	 edx, DWORD PTR _Section$[ebp]
  00106	8b 44 02 0c	 mov	 eax, DWORD PTR [edx+eax+12]
  0010a	8b 55 fc	 mov	 edx, DWORD PTR _Section$[ebp]
  0010d	03 44 0a 08	 add	 eax, DWORD PTR [edx+ecx+8]
  00111	89 45 ec	 mov	 DWORD PTR _SectionEnd$[ebp], eax

; 245  : 
; 246  :         if (SectionEnd > *VirtualSize) {

  00114	8b 45 08	 mov	 eax, DWORD PTR _VirtualSize$[ebp]
  00117	8b 4d ec	 mov	 ecx, DWORD PTR _SectionEnd$[ebp]
  0011a	3b 08		 cmp	 ecx, DWORD PTR [eax]
  0011c	76 08		 jbe	 SHORT $LN1@BlPeGetVir

; 247  : 
; 248  :             *VirtualSize = SectionEnd;

  0011e	8b 45 08	 mov	 eax, DWORD PTR _VirtualSize$[ebp]
  00121	8b 4d ec	 mov	 ecx, DWORD PTR _SectionEnd$[ebp]
  00124	89 08		 mov	 DWORD PTR [eax], ecx
$LN1@BlPeGetVir:

; 249  :         }
; 250  :     }

  00126	eb bc		 jmp	 SHORT $LN3@BlPeGetVir
$LN2@BlPeGetVir:

; 251  : 
; 252  :     *VirtualSize = ROUND_UP_TO_PAGES(*VirtualSize);

  00128	8b 45 08	 mov	 eax, DWORD PTR _VirtualSize$[ebp]
  0012b	8b 00		 mov	 eax, DWORD PTR [eax]
  0012d	05 ff 0f 00 00	 add	 eax, 4095		; 00000fffH
  00132	25 00 f0 ff ff	 and	 eax, -4096		; fffff000H
  00137	8b 4d 08	 mov	 ecx, DWORD PTR _VirtualSize$[ebp]
  0013a	89 01		 mov	 DWORD PTR [ecx], eax

; 253  : 
; 254  :     return;
; 255  : }

  0013c	c9		 leave
  0013d	c2 04 00	 ret	 4
?BlPeGetVirtualRange@@YIXPAXPAPAXPAK@Z ENDP		; BlPeGetVirtualRange
_TEXT	ENDS
PUBLIC	??_C@_0BN@HECJPAFH@PECOFF?3?5Illegal?5relocation?4?6?$AA@ ; `string'
PUBLIC	?BlPeApplyFixupBlock@@YIXPAU_IMAGE_BASE_RELOCATION@@KK@Z ; BlPeApplyFixupBlock
;	COMDAT ??_C@_0BN@HECJPAFH@PECOFF?3?5Illegal?5relocation?4?6?$AA@
CONST	SEGMENT
??_C@_0BN@HECJPAFH@PECOFF?3?5Illegal?5relocation?4?6?$AA@ DB 'PECOFF: Ill'
	DB	'egal relocation.', 0aH, 00H			; `string'
; Function compile flags: /Odsp
CONST	ENDS
;	COMDAT ?BlPeApplyFixupBlock@@YIXPAU_IMAGE_BASE_RELOCATION@@KK@Z
_TEXT	SEGMENT
tv75 = -28						; size = 4
_VirtualBase$ = -24					; size = 4
_Block$ = -20						; size = 4
_BlockBase$ = -16					; size = 4
_Reloc$ = -12						; size = 4
_Target$ = -8						; size = 4
_BlockEnd$ = -4						; size = 4
_RelocDiff$ = 8						; size = 4
?BlPeApplyFixupBlock@@YIXPAU_IMAGE_BASE_RELOCATION@@KK@Z PROC ; BlPeApplyFixupBlock, COMDAT
; _Block$ = ecx
; _VirtualBase$ = edx

; 280  : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 1c	 sub	 esp, 28			; 0000001cH
  00006	89 55 e8	 mov	 DWORD PTR _VirtualBase$[ebp], edx
  00009	89 4d ec	 mov	 DWORD PTR _Block$[ebp], ecx

; 281  :     PUINT16 Reloc;
; 282  :     PUINT16 BlockEnd;
; 283  :     ULONG_PTR BlockBase;
; 284  :     ULONG_PTR Target;
; 285  : 
; 286  :     Reloc = Block->TypeOffset;

  0000c	8b 45 ec	 mov	 eax, DWORD PTR _Block$[ebp]
  0000f	83 c0 08	 add	 eax, 8
  00012	89 45 f4	 mov	 DWORD PTR _Reloc$[ebp], eax

; 287  :     BlockEnd = (PUINT16) ( ((PUINT8) Block) + Block->SizeOfBlock);

  00015	8b 45 ec	 mov	 eax, DWORD PTR _Block$[ebp]
  00018	8b 4d ec	 mov	 ecx, DWORD PTR _Block$[ebp]
  0001b	03 48 04	 add	 ecx, DWORD PTR [eax+4]
  0001e	89 4d fc	 mov	 DWORD PTR _BlockEnd$[ebp], ecx

; 288  :     BlockBase = VirtualBase + Block->VirtualAddress;

  00021	8b 45 ec	 mov	 eax, DWORD PTR _Block$[ebp]
  00024	8b 4d e8	 mov	 ecx, DWORD PTR _VirtualBase$[ebp]
  00027	03 08		 add	 ecx, DWORD PTR [eax]
  00029	89 4d f0	 mov	 DWORD PTR _BlockBase$[ebp], ecx
  0002c	eb 08		 jmp	 SHORT $LN9@BlPeApplyF
$LN8@BlPeApplyF:

; 289  : 
; 290  : #if PECOFF_VERBOSE
; 291  : 
; 292  :     BlRtlPrintf("PECOFF: Reloc Block %p:\n", Block->VirtualAddress);
; 293  : 
; 294  : #endif
; 295  : 
; 296  :     for (; Reloc < BlockEnd; Reloc++) {

  0002e	8b 45 f4	 mov	 eax, DWORD PTR _Reloc$[ebp]
  00031	40		 inc	 eax
  00032	40		 inc	 eax
  00033	89 45 f4	 mov	 DWORD PTR _Reloc$[ebp], eax
$LN9@BlPeApplyF:
  00036	8b 45 f4	 mov	 eax, DWORD PTR _Reloc$[ebp]
  00039	3b 45 fc	 cmp	 eax, DWORD PTR _BlockEnd$[ebp]
  0003c	73 6e		 jae	 SHORT $LN10@BlPeApplyF

; 297  : 
; 298  :         Target = BlockBase + (*Reloc & 0xfff);

  0003e	8b 45 f4	 mov	 eax, DWORD PTR _Reloc$[ebp]
  00041	0f b7 00	 movzx	 eax, WORD PTR [eax]
  00044	25 ff 0f 00 00	 and	 eax, 4095		; 00000fffH
  00049	03 45 f0	 add	 eax, DWORD PTR _BlockBase$[ebp]
  0004c	89 45 f8	 mov	 DWORD PTR _Target$[ebp], eax

; 299  : 
; 300  : #if PECOFF_VERBOSE
; 301  : 
; 302  :         switch (*Reloc >> 12) {
; 303  : 
; 304  :             case IMAGE_REL_BASED_ABSOLUTE: {
; 305  : 
; 306  :                 BlRtlPrintf("PECOFF:  %p: abs:%x \r", (PUINT32) Target, * (PUINT32) Target);
; 307  :                 break;
; 308  :             }
; 309  : 
; 310  :             case IMAGE_REL_BASED_HIGHLOW: {
; 311  : 
; 312  :                 BlRtlPrintf("PECOFF:  %p: r32:%x->%x \r", (PUINT32) Target, * (PUINT32) Target, * (PUINT32) Target + (UINT32) RelocDiff);
; 313  :                 break;
; 314  :             }
; 315  : 
; 316  :             case IMAGE_REL_BASED_DIR64: {
; 317  : 
; 318  :                 BlRtlPrintf("PECOFF:  %p: r64:%lx->%lx \r", (PUINT64) Target, * (PUINT64) Target, * (PUINT64) Target + (UINT64) RelocDiff);
; 319  :                 break;
; 320  :             }
; 321  : 
; 322  :             default: {
; 323  : 
; 324  :                 BlRtlPrintf("PECOFF:  %p: %x ??? \r", (PUINT32) Target, Reloc[0] >> 12);
; 325  :                 break;
; 326  :             }
; 327  :         }
; 328  : 
; 329  : #endif
; 330  : 
; 331  :         switch (*Reloc >> 12) {

  0004f	8b 45 f4	 mov	 eax, DWORD PTR _Reloc$[ebp]
  00052	0f b7 00	 movzx	 eax, WORD PTR [eax]
  00055	c1 f8 0c	 sar	 eax, 12			; 0000000cH
  00058	89 45 e4	 mov	 DWORD PTR tv75[ebp], eax
  0005b	74 0e		 je	 SHORT $LN4@BlPeApplyF
  0005d	83 7d e4 03	 cmp	 DWORD PTR tv75[ebp], 3
  00061	74 0a		 je	 SHORT $LN3@BlPeApplyF
  00063	83 7d e4 0a	 cmp	 DWORD PTR tv75[ebp], 10	; 0000000aH
  00067	74 13		 je	 SHORT $LN2@BlPeApplyF
  00069	eb 25		 jmp	 SHORT $LN1@BlPeApplyF
$LN4@BlPeApplyF:

; 332  :             case IMAGE_REL_BASED_ABSOLUTE: {
; 333  : 
; 334  :                 break;

  0006b	eb 3d		 jmp	 SHORT $LN5@BlPeApplyF
$LN3@BlPeApplyF:

; 335  :             }
; 336  : 
; 337  :             case IMAGE_REL_BASED_HIGHLOW: {
; 338  : 
; 339  :                 * (PUINT32) Target += (UINT32) RelocDiff;

  0006d	8b 45 f8	 mov	 eax, DWORD PTR _Target$[ebp]
  00070	8b 00		 mov	 eax, DWORD PTR [eax]
  00072	03 45 08	 add	 eax, DWORD PTR _RelocDiff$[ebp]
  00075	8b 4d f8	 mov	 ecx, DWORD PTR _Target$[ebp]
  00078	89 01		 mov	 DWORD PTR [ecx], eax

; 340  :                 break;

  0007a	eb 2e		 jmp	 SHORT $LN5@BlPeApplyF
$LN2@BlPeApplyF:

; 341  :             }
; 342  : 
; 343  :             case IMAGE_REL_BASED_DIR64: {
; 344  : 
; 345  :                 * (PUINT64 *) Target += (UINT64) RelocDiff;

  0007c	8b 45 08	 mov	 eax, DWORD PTR _RelocDiff$[ebp]
  0007f	6a 08		 push	 8
  00081	59		 pop	 ecx
  00082	f7 e1		 mul	 ecx
  00084	8b 4d f8	 mov	 ecx, DWORD PTR _Target$[ebp]
  00087	03 01		 add	 eax, DWORD PTR [ecx]
  00089	8b 4d f8	 mov	 ecx, DWORD PTR _Target$[ebp]
  0008c	89 01		 mov	 DWORD PTR [ecx], eax

; 346  :                 break;

  0008e	eb 1a		 jmp	 SHORT $LN5@BlPeApplyF
$LN1@BlPeApplyF:

; 347  :             }
; 348  : 
; 349  :             default: {
; 350  : 
; 351  :                 BlRtlPrintf("PECOFF: Illegal relocation.\n");

  00090	68 00 00 00 00	 push	 OFFSET ??_C@_0BN@HECJPAFH@PECOFF?3?5Illegal?5relocation?4?6?$AA@
  00095	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  0009a	59		 pop	 ecx

; 352  :                 BlRtlHalt();

  0009b	ba 60 01 00 00	 mov	 edx, 352		; 00000160H
  000a0	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  000a5	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN5@BlPeApplyF:

; 353  :             }
; 354  :         }
; 355  :     }

  000aa	eb 82		 jmp	 SHORT $LN8@BlPeApplyF
$LN10@BlPeApplyF:

; 356  : }

  000ac	c9		 leave
  000ad	c2 04 00	 ret	 4
?BlPeApplyFixupBlock@@YIXPAU_IMAGE_BASE_RELOCATION@@KK@Z ENDP ; BlPeApplyFixupBlock
_TEXT	ENDS
PUBLIC	??_C@_0BL@IMODACNC@PECOFF?3?5Not?5page?5aligned?4?6?$AA@ ; `string'
PUBLIC	??_C@_0BG@MHIILMKK@PECOFF?3?5No?5sections?$CB?6?$AA@ ; `string'
PUBLIC	??_C@_0BF@ECDALOID@PECOFF?3?5Missing?5PE?$CB?6?$AA@ ; `string'
PUBLIC	??_C@_0BF@NCDKKKHJ@PECOFF?3?5Missing?5MZ?$CB?6?$AA@ ; `string'
PUBLIC	?BlPeLoadImage@@YIXPAX0PAPAX@Z			; BlPeLoadImage
EXTRN	?BlRtlZeroMemory@@YIXPAXK@Z:PROC		; BlRtlZeroMemory
EXTRN	?BlRtlCopyMemory@@YIXPAXPBXK@Z:PROC		; BlRtlCopyMemory
;	COMDAT ??_C@_0BL@IMODACNC@PECOFF?3?5Not?5page?5aligned?4?6?$AA@
CONST	SEGMENT
??_C@_0BL@IMODACNC@PECOFF?3?5Not?5page?5aligned?4?6?$AA@ DB 'PECOFF: Not '
	DB	'page aligned.', 0aH, 00H			; `string'
CONST	ENDS
;	COMDAT ??_C@_0BG@MHIILMKK@PECOFF?3?5No?5sections?$CB?6?$AA@
CONST	SEGMENT
??_C@_0BG@MHIILMKK@PECOFF?3?5No?5sections?$CB?6?$AA@ DB 'PECOFF: No secti'
	DB	'ons!', 0aH, 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0BF@ECDALOID@PECOFF?3?5Missing?5PE?$CB?6?$AA@
CONST	SEGMENT
??_C@_0BF@ECDALOID@PECOFF?3?5Missing?5PE?$CB?6?$AA@ DB 'PECOFF: Missing P'
	DB	'E!', 0aH, 00H				; `string'
CONST	ENDS
;	COMDAT ??_C@_0BF@NCDKKKHJ@PECOFF?3?5Missing?5MZ?$CB?6?$AA@
CONST	SEGMENT
??_C@_0BF@NCDKKKHJ@PECOFF?3?5Missing?5MZ?$CB?6?$AA@ DB 'PECOFF: Missing M'
	DB	'Z!', 0aH, 00H				; `string'
; Function compile flags: /Odsp
CONST	ENDS
;	COMDAT ?BlPeLoadImage@@YIXPAX0PAPAX@Z
_TEXT	SEGMENT
_Image$ = -48						; size = 4
_LoadBase$ = -44					; size = 4
_Block$3514 = -40					; size = 4
_RelocListEnd$3513 = -36				; size = 4
_RelocList$3512 = -32					; size = 4
_DosHeader$ = -28					; size = 4
_RelocDiff$ = -24					; size = 4
_BytesToCopy$ = -20					; size = 4
_VirtualBase$ = -16					; size = 4
_Index$ = -12						; size = 4
_NtHeader$ = -8						; size = 4
_Section$ = -4						; size = 4
_EntryPoint$ = 8					; size = 4
?BlPeLoadImage@@YIXPAX0PAPAX@Z PROC			; BlPeLoadImage, COMDAT
; _LoadBase$ = ecx
; _Image$ = edx

; 379  : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 30	 sub	 esp, 48			; 00000030H
  00006	56		 push	 esi
  00007	89 55 d0	 mov	 DWORD PTR _Image$[ebp], edx
  0000a	89 4d d4	 mov	 DWORD PTR _LoadBase$[ebp], ecx

; 380  :     ULONG_PTR BytesToCopy;
; 381  :     PIMAGE_DOS_HEADER DosHeader;
; 382  :     UINT32 Index;
; 383  :     PIMAGE_NT_HEADERS NtHeader;
; 384  :     PIMAGE_SECTION_HEADER Section;
; 385  :     ULONG_PTR VirtualBase;
; 386  :     ULONG_PTR RelocDiff;
; 387  : 
; 388  :     VirtualBase = (ULONG_PTR) LoadBase;

  0000d	8b 45 d4	 mov	 eax, DWORD PTR _LoadBase$[ebp]
  00010	89 45 f0	 mov	 DWORD PTR _VirtualBase$[ebp], eax

; 389  :     DosHeader = (PIMAGE_DOS_HEADER) Image;

  00013	8b 45 d0	 mov	 eax, DWORD PTR _Image$[ebp]
  00016	89 45 e4	 mov	 DWORD PTR _DosHeader$[ebp], eax

; 390  : 
; 391  :     if (DosHeader->e_magic != IMAGE_DOS_SIGNATURE) {

  00019	8b 45 e4	 mov	 eax, DWORD PTR _DosHeader$[ebp]
  0001c	0f b7 00	 movzx	 eax, WORD PTR [eax]
  0001f	3d 4d 5a 00 00	 cmp	 eax, 23117		; 00005a4dH
  00024	74 1a		 je	 SHORT $LN12@BlPeLoadIm

; 392  : 
; 393  :         BlRtlPrintf("PECOFF: Missing MZ!\n");

  00026	68 00 00 00 00	 push	 OFFSET ??_C@_0BF@NCDKKKHJ@PECOFF?3?5Missing?5MZ?$CB?6?$AA@
  0002b	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  00030	59		 pop	 ecx

; 394  :         BlRtlHalt();

  00031	ba 8a 01 00 00	 mov	 edx, 394		; 0000018aH
  00036	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  0003b	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN12@BlPeLoadIm:

; 395  :     }
; 396  : 
; 397  :     NtHeader = (PIMAGE_NT_HEADERS) ((ULONG_PTR) Image + DosHeader->e_lfanew);

  00040	8b 45 e4	 mov	 eax, DWORD PTR _DosHeader$[ebp]
  00043	8b 4d d0	 mov	 ecx, DWORD PTR _Image$[ebp]
  00046	03 48 3c	 add	 ecx, DWORD PTR [eax+60]
  00049	89 4d f8	 mov	 DWORD PTR _NtHeader$[ebp], ecx

; 398  : 
; 399  :     if (NtHeader->Signature != IMAGE_NT_SIGNATURE) {

  0004c	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  0004f	81 38 50 45 00
	00		 cmp	 DWORD PTR [eax], 17744	; 00004550H
  00055	74 1a		 je	 SHORT $LN11@BlPeLoadIm

; 400  : 
; 401  :         BlRtlPrintf("PECOFF: Missing PE!\n");

  00057	68 00 00 00 00	 push	 OFFSET ??_C@_0BF@ECDALOID@PECOFF?3?5Missing?5PE?$CB?6?$AA@
  0005c	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  00061	59		 pop	 ecx

; 402  :         BlRtlHalt();

  00062	ba 92 01 00 00	 mov	 edx, 402		; 00000192H
  00067	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  0006c	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN11@BlPeLoadIm:

; 403  :     }
; 404  : 
; 405  :     if (NtHeader->FileHeader.NumberOfSections == 0) {

  00071	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  00074	0f b7 40 06	 movzx	 eax, WORD PTR [eax+6]
  00078	85 c0		 test	 eax, eax
  0007a	75 1a		 jne	 SHORT $LN10@BlPeLoadIm

; 406  : 
; 407  :         BlRtlPrintf("PECOFF: No sections!\n");

  0007c	68 00 00 00 00	 push	 OFFSET ??_C@_0BG@MHIILMKK@PECOFF?3?5No?5sections?$CB?6?$AA@
  00081	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  00086	59		 pop	 ecx

; 408  :         BlRtlHalt();

  00087	ba 98 01 00 00	 mov	 edx, 408		; 00000198H
  0008c	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  00091	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN10@BlPeLoadIm:

; 409  :     }
; 410  : 
; 411  :     if ((NtHeader->OptionalHeader.ImageBase % PAGE_SIZE) != 0) {

  00096	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  00099	8b 40 34	 mov	 eax, DWORD PTR [eax+52]
  0009c	33 d2		 xor	 edx, edx
  0009e	b9 00 10 00 00	 mov	 ecx, 4096		; 00001000H
  000a3	f7 f1		 div	 ecx
  000a5	85 d2		 test	 edx, edx
  000a7	74 1a		 je	 SHORT $LN9@BlPeLoadIm

; 412  : 
; 413  :         BlRtlPrintf("PECOFF: Not page aligned.\n");

  000a9	68 00 00 00 00	 push	 OFFSET ??_C@_0BL@IMODACNC@PECOFF?3?5Not?5page?5aligned?4?6?$AA@
  000ae	e8 00 00 00 00	 call	 ?BlRtlPrintf@@YAEPBDZZ	; BlRtlPrintf
  000b3	59		 pop	 ecx

; 414  :         BlRtlHalt();

  000b4	ba 9e 01 00 00	 mov	 edx, 414		; 0000019eH
  000b9	b9 00 00 00 00	 mov	 ecx, OFFSET ??_C@_0N@MNCCIOG@blpecoff?4cpp?$AA@
  000be	e8 00 00 00 00	 call	 ?BlRtlHaltInternal@@YIXPBDK@Z ; BlRtlHaltInternal
$LN9@BlPeLoadIm:

; 415  :     }
; 416  : 
; 417  :     BlRtlCopyMemory((PVOID) VirtualBase,
; 418  :                     Image,
; 419  :                     NtHeader->OptionalHeader.SizeOfHeaders);

  000c3	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  000c6	ff 70 54	 push	 DWORD PTR [eax+84]
  000c9	8b 55 d0	 mov	 edx, DWORD PTR _Image$[ebp]
  000cc	8b 4d f0	 mov	 ecx, DWORD PTR _VirtualBase$[ebp]
  000cf	e8 00 00 00 00	 call	 ?BlRtlCopyMemory@@YIXPAXPBXK@Z ; BlRtlCopyMemory

; 420  : 
; 421  :     Section = (PIMAGE_SECTION_HEADER) (((ULONG_PTR) &NtHeader->OptionalHeader) + NtHeader->FileHeader.SizeOfOptionalHeader);

  000d4	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  000d7	0f b7 40 14	 movzx	 eax, WORD PTR [eax+20]
  000db	8b 4d f8	 mov	 ecx, DWORD PTR _NtHeader$[ebp]
  000de	8d 44 01 18	 lea	 eax, DWORD PTR [ecx+eax+24]
  000e2	89 45 fc	 mov	 DWORD PTR _Section$[ebp], eax

; 422  : 
; 423  :     for (Index = 0; Index < NtHeader->FileHeader.NumberOfSections; Index += 1) {

  000e5	83 65 f4 00	 and	 DWORD PTR _Index$[ebp], 0
  000e9	eb 07		 jmp	 SHORT $LN8@BlPeLoadIm
$LN7@BlPeLoadIm:
  000eb	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  000ee	40		 inc	 eax
  000ef	89 45 f4	 mov	 DWORD PTR _Index$[ebp], eax
$LN8@BlPeLoadIm:
  000f2	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  000f5	0f b7 40 06	 movzx	 eax, WORD PTR [eax+6]
  000f9	39 45 f4	 cmp	 DWORD PTR _Index$[ebp], eax
  000fc	0f 83 91 00 00
	00		 jae	 $LN6@BlPeLoadIm

; 424  : 
; 425  :         BlRtlZeroMemory((PVOID) (VirtualBase + Section[Index].VirtualAddress), Section[Index].Misc.VirtualSize);

  00102	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  00105	6b c0 28	 imul	 eax, 40			; 00000028H
  00108	8b 4d f4	 mov	 ecx, DWORD PTR _Index$[ebp]
  0010b	6b c9 28	 imul	 ecx, 40			; 00000028H
  0010e	8b 55 fc	 mov	 edx, DWORD PTR _Section$[ebp]
  00111	8b 75 f0	 mov	 esi, DWORD PTR _VirtualBase$[ebp]
  00114	03 74 0a 0c	 add	 esi, DWORD PTR [edx+ecx+12]
  00118	8b 4d fc	 mov	 ecx, DWORD PTR _Section$[ebp]
  0011b	8b 54 01 08	 mov	 edx, DWORD PTR [ecx+eax+8]
  0011f	8b ce		 mov	 ecx, esi
  00121	e8 00 00 00 00	 call	 ?BlRtlZeroMemory@@YIXPAXK@Z ; BlRtlZeroMemory

; 426  : 
; 427  :         if (Section[Index].SizeOfRawData < Section[Index].Misc.VirtualSize) {

  00126	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  00129	6b c0 28	 imul	 eax, 40			; 00000028H
  0012c	8b 4d f4	 mov	 ecx, DWORD PTR _Index$[ebp]
  0012f	6b c9 28	 imul	 ecx, 40			; 00000028H
  00132	8b 55 fc	 mov	 edx, DWORD PTR _Section$[ebp]
  00135	8b 75 fc	 mov	 esi, DWORD PTR _Section$[ebp]
  00138	8b 44 02 10	 mov	 eax, DWORD PTR [edx+eax+16]
  0013c	3b 44 0e 08	 cmp	 eax, DWORD PTR [esi+ecx+8]
  00140	73 12		 jae	 SHORT $LN5@BlPeLoadIm

; 428  : 
; 429  :             BytesToCopy = Section[Index].SizeOfRawData;

  00142	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  00145	6b c0 28	 imul	 eax, 40			; 00000028H
  00148	8b 4d fc	 mov	 ecx, DWORD PTR _Section$[ebp]
  0014b	8b 44 01 10	 mov	 eax, DWORD PTR [ecx+eax+16]
  0014f	89 45 ec	 mov	 DWORD PTR _BytesToCopy$[ebp], eax

; 430  : 
; 431  :         } else {

  00152	eb 10		 jmp	 SHORT $LN4@BlPeLoadIm
$LN5@BlPeLoadIm:

; 432  : 
; 433  :             BytesToCopy = Section[Index].Misc.VirtualSize;

  00154	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  00157	6b c0 28	 imul	 eax, 40			; 00000028H
  0015a	8b 4d fc	 mov	 ecx, DWORD PTR _Section$[ebp]
  0015d	8b 44 01 08	 mov	 eax, DWORD PTR [ecx+eax+8]
  00161	89 45 ec	 mov	 DWORD PTR _BytesToCopy$[ebp], eax
$LN4@BlPeLoadIm:

; 434  :         }
; 435  : 
; 436  :         BlRtlCopyMemory((PVOID) (VirtualBase + Section[Index].VirtualAddress),
; 437  :                         (PVOID) (((ULONG_PTR) Image) + Section[Index].PointerToRawData),
; 438  :                         BytesToCopy);

  00164	ff 75 ec	 push	 DWORD PTR _BytesToCopy$[ebp]
  00167	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  0016a	6b c0 28	 imul	 eax, 40			; 00000028H
  0016d	8b 4d fc	 mov	 ecx, DWORD PTR _Section$[ebp]
  00170	8b 55 d0	 mov	 edx, DWORD PTR _Image$[ebp]
  00173	03 54 01 14	 add	 edx, DWORD PTR [ecx+eax+20]
  00177	8b 45 f4	 mov	 eax, DWORD PTR _Index$[ebp]
  0017a	6b c0 28	 imul	 eax, 40			; 00000028H
  0017d	8b 4d fc	 mov	 ecx, DWORD PTR _Section$[ebp]
  00180	8b 75 f0	 mov	 esi, DWORD PTR _VirtualBase$[ebp]
  00183	03 74 01 0c	 add	 esi, DWORD PTR [ecx+eax+12]
  00187	8b ce		 mov	 ecx, esi
  00189	e8 00 00 00 00	 call	 ?BlRtlCopyMemory@@YIXPAXPBXK@Z ; BlRtlCopyMemory

; 439  : 
; 440  : #if PECOFF_VERBOSE
; 441  : 
; 442  :         {
; 443  :             CHAR Temp[IMAGE_SIZEOF_SHORT_NAME + 1];
; 444  : 
; 445  :             BlRtlCopyMemory(Temp,
; 446  :                             Section[Index].Name,
; 447  :                             IMAGE_SIZEOF_SHORT_NAME);
; 448  : 
; 449  :             Temp[IMAGE_SIZEOF_SHORT_NAME] = 0;
; 450  : 
; 451  :             BlRtlPrintf("PECOFF: %p ... %p (%p ... %p) %s\n",
; 452  :                         VirtualBase + Section[Index].VirtualAddress,
; 453  :                         VirtualBase + Section[Index].VirtualAddress + Section[Index].Misc.VirtualSize - 1,
; 454  :                         (((ULONG_PTR) Image) + Section[Index].PointerToRawData),
; 455  :                         (((ULONG_PTR) Image) + Section[Index].PointerToRawData) + BytesToCopy,
; 456  :                         Temp);
; 457  :         }
; 458  : 
; 459  : #endif
; 460  : 
; 461  :     }

  0018e	e9 58 ff ff ff	 jmp	 $LN7@BlPeLoadIm
$LN6@BlPeLoadIm:

; 462  : 
; 463  :     RelocDiff = VirtualBase - (ULONG_PTR)NtHeader->OptionalHeader.ImageBase;

  00193	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  00196	8b 4d f0	 mov	 ecx, DWORD PTR _VirtualBase$[ebp]
  00199	2b 48 34	 sub	 ecx, DWORD PTR [eax+52]
  0019c	89 4d e8	 mov	 DWORD PTR _RelocDiff$[ebp], ecx

; 464  : 
; 465  :     if (RelocDiff != 0) {

  0019f	74 48		 je	 SHORT $LN3@BlPeLoadIm

; 466  : 
; 467  :         PUINT8 RelocList;
; 468  :         PUINT8 RelocListEnd;
; 469  :         PIMAGE_BASE_RELOCATION Block;
; 470  : 
; 471  :         RelocList = (PUINT8) (VirtualBase + NtHeader->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress);

  001a1	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  001a4	8b 4d f0	 mov	 ecx, DWORD PTR _VirtualBase$[ebp]
  001a7	03 88 a0 00 00
	00		 add	 ecx, DWORD PTR [eax+160]
  001ad	89 4d e0	 mov	 DWORD PTR _RelocList$3512[ebp], ecx

; 472  :         RelocListEnd = RelocList + NtHeader->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].Size;

  001b0	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  001b3	8b 4d e0	 mov	 ecx, DWORD PTR _RelocList$3512[ebp]
  001b6	03 88 a4 00 00
	00		 add	 ecx, DWORD PTR [eax+164]
  001bc	89 4d dc	 mov	 DWORD PTR _RelocListEnd$3513[ebp], ecx
$LN2@BlPeLoadIm:

; 473  : 
; 474  : #if PECOFF_VERBOSE
; 475  : 
; 476  :         BlRtlPrintf("PECOFF: Relocs: %p ... %p\n", RelocList, RelocListEnd);
; 477  : 
; 478  : #endif
; 479  : 
; 480  :         while (RelocList < RelocListEnd) {

  001bf	8b 45 e0	 mov	 eax, DWORD PTR _RelocList$3512[ebp]
  001c2	3b 45 dc	 cmp	 eax, DWORD PTR _RelocListEnd$3513[ebp]
  001c5	73 22		 jae	 SHORT $LN3@BlPeLoadIm

; 481  : 
; 482  :             Block = (PIMAGE_BASE_RELOCATION) RelocList;

  001c7	8b 45 e0	 mov	 eax, DWORD PTR _RelocList$3512[ebp]
  001ca	89 45 d8	 mov	 DWORD PTR _Block$3514[ebp], eax

; 483  : 
; 484  :             BlPeApplyFixupBlock(Block, VirtualBase, RelocDiff);

  001cd	ff 75 e8	 push	 DWORD PTR _RelocDiff$[ebp]
  001d0	8b 55 f0	 mov	 edx, DWORD PTR _VirtualBase$[ebp]
  001d3	8b 4d d8	 mov	 ecx, DWORD PTR _Block$3514[ebp]
  001d6	e8 00 00 00 00	 call	 ?BlPeApplyFixupBlock@@YIXPAU_IMAGE_BASE_RELOCATION@@KK@Z ; BlPeApplyFixupBlock

; 485  : 
; 486  :             RelocList += Block->SizeOfBlock;

  001db	8b 45 d8	 mov	 eax, DWORD PTR _Block$3514[ebp]
  001de	8b 4d e0	 mov	 ecx, DWORD PTR _RelocList$3512[ebp]
  001e1	03 48 04	 add	 ecx, DWORD PTR [eax+4]
  001e4	89 4d e0	 mov	 DWORD PTR _RelocList$3512[ebp], ecx

; 487  :         }

  001e7	eb d6		 jmp	 SHORT $LN2@BlPeLoadIm
$LN3@BlPeLoadIm:

; 488  :     }
; 489  : 
; 490  :     *EntryPoint = (PVOID) (VirtualBase + NtHeader->OptionalHeader.AddressOfEntryPoint);

  001e9	8b 45 f8	 mov	 eax, DWORD PTR _NtHeader$[ebp]
  001ec	8b 4d f0	 mov	 ecx, DWORD PTR _VirtualBase$[ebp]
  001ef	03 48 28	 add	 ecx, DWORD PTR [eax+40]
  001f2	8b 45 08	 mov	 eax, DWORD PTR _EntryPoint$[ebp]
  001f5	89 08		 mov	 DWORD PTR [eax], ecx

; 491  : 
; 492  :     return;
; 493  : }

  001f7	5e		 pop	 esi
  001f8	c9		 leave
  001f9	c2 04 00	 ret	 4
?BlPeLoadImage@@YIXPAX0PAPAX@Z ENDP			; BlPeLoadImage
_TEXT	ENDS
END
