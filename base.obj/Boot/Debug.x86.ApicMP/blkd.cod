; Listing generated by Microsoft (R) Optimizing Compiler Version 14.00.50727.762 

	TITLE	C:\Users\cc\source\repos\Singularity-OS\base\Boot\SingLdrPc\blkd.cpp
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	?BlKdNextPacketId@@3KA				; BlKdNextPacketId
_BSS	SEGMENT
?BlKdNextPacketId@@3KA DD 01H DUP (?)			; BlKdNextPacketId
_BSS	ENDS
PUBLIC	??_C@_04OPBEDMAI@?$CL?9?$HM?$CK?$AA@		; `string'
PUBLIC	?BlKdSpin@@YIXXZ				; BlKdSpin
;	COMDAT ?state@?1??BlKdSpin@@YIXXZ@4EA
; File c:\users\cc\source\repos\singularity-os\base\boot\singldrpc\blkd.cpp
_BSS	SEGMENT
?state@?1??BlKdSpin@@YIXXZ@4EA DB 01H DUP (?)		; `BlKdSpin'::`2'::state
_BSS	ENDS
;	COMDAT ??_C@_04OPBEDMAI@?$CL?9?$HM?$CK?$AA@
CONST	SEGMENT
??_C@_04OPBEDMAI@?$CL?9?$HM?$CK?$AA@ DB '+-|*', 00H	; `string'
; Function compile flags: /Odsp
CONST	ENDS
;	COMDAT ?BlKdSpin@@YIXXZ
_TEXT	SEGMENT
?BlKdSpin@@YIXXZ PROC					; BlKdSpin, COMDAT

; 32   : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp

; 33   :     static UINT8 state = 0;
; 34   : 
; 35   :     //
; 36   :     // Write the spinner character to the top left corner of the screen.
; 37   :     //
; 38   : 
; 39   :     *((UINT16 *)(ULONG_PTR)0xb809e) = 0x2f00 + ("+-|*" [state++ & 0x3]);

  00003	0f b6 05 00 00
	00 00		 movzx	 eax, BYTE PTR ?state@?1??BlKdSpin@@YIXXZ@4EA
  0000a	83 e0 03	 and	 eax, 3
  0000d	0f be 80 00 00
	00 00		 movsx	 eax, BYTE PTR ??_C@_04OPBEDMAI@?$CL?9?$HM?$CK?$AA@[eax]
  00014	05 00 2f 00 00	 add	 eax, 12032		; 00002f00H
  00019	66 a3 9e 80 0b
	00		 mov	 WORD PTR ds:753822, ax
  0001f	a0 00 00 00 00	 mov	 al, BYTE PTR ?state@?1??BlKdSpin@@YIXXZ@4EA
  00024	04 01		 add	 al, 1
  00026	a2 00 00 00 00	 mov	 BYTE PTR ?state@?1??BlKdSpin@@YIXXZ@4EA, al

; 40   : }

  0002b	5d		 pop	 ebp
  0002c	c3		 ret	 0
?BlKdSpin@@YIXXZ ENDP					; BlKdSpin
_TEXT	ENDS
PUBLIC	?BlKdComputeChecksum@@YIKPBXK@Z			; BlKdComputeChecksum
; Function compile flags: /Odsp
;	COMDAT ?BlKdComputeChecksum@@YIKPBXK@Z
_TEXT	SEGMENT
_Length$ = -16						; size = 4
_Buffer$ = -12						; size = 4
_Checksum$ = -8						; size = 4
_Index$ = -4						; size = 4
?BlKdComputeChecksum@@YIKPBXK@Z PROC			; BlKdComputeChecksum, COMDAT
; _Buffer$ = ecx
; _Length$ = edx

; 66   : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 10	 sub	 esp, 16			; 00000010H
  00006	89 55 f0	 mov	 DWORD PTR _Length$[ebp], edx
  00009	89 4d f4	 mov	 DWORD PTR _Buffer$[ebp], ecx

; 67   :     UINT32 Checksum;
; 68   :     UINT32 Index;
; 69   : 
; 70   :     Checksum = 0;

  0000c	83 65 f8 00	 and	 DWORD PTR _Checksum$[ebp], 0

; 71   : 
; 72   :     for (Index = 0; Index < Length; Index += 1) {

  00010	83 65 fc 00	 and	 DWORD PTR _Index$[ebp], 0
  00014	eb 07		 jmp	 SHORT $LN3@BlKdComput
$LN2@BlKdComput:
  00016	8b 45 fc	 mov	 eax, DWORD PTR _Index$[ebp]
  00019	40		 inc	 eax
  0001a	89 45 fc	 mov	 DWORD PTR _Index$[ebp], eax
$LN3@BlKdComput:
  0001d	8b 45 fc	 mov	 eax, DWORD PTR _Index$[ebp]
  00020	3b 45 f0	 cmp	 eax, DWORD PTR _Length$[ebp]
  00023	73 11		 jae	 SHORT $LN1@BlKdComput

; 73   : 
; 74   :         Checksum += ((PCHAR)Buffer)[Index];

  00025	8b 45 f4	 mov	 eax, DWORD PTR _Buffer$[ebp]
  00028	03 45 fc	 add	 eax, DWORD PTR _Index$[ebp]
  0002b	0f be 00	 movsx	 eax, BYTE PTR [eax]
  0002e	03 45 f8	 add	 eax, DWORD PTR _Checksum$[ebp]
  00031	89 45 f8	 mov	 DWORD PTR _Checksum$[ebp], eax

; 75   :     }

  00034	eb e0		 jmp	 SHORT $LN2@BlKdComput
$LN1@BlKdComput:

; 76   : 
; 77   :     return Checksum;

  00036	8b 45 f8	 mov	 eax, DWORD PTR _Checksum$[ebp]

; 78   : }

  00039	c9		 leave
  0003a	c3		 ret	 0
?BlKdComputeChecksum@@YIKPBXK@Z ENDP			; BlKdComputeChecksum
_TEXT	ENDS
PUBLIC	?BlKdPrintString@@YIEPBD@Z			; BlKdPrintString
EXTRN	?BlKd1394SendPacket@@YIEGPBXG0G@Z:PROC		; BlKd1394SendPacket
EXTRN	?BlPciOhci1394BaseAddress@@3KA:DWORD		; BlPciOhci1394BaseAddress
EXTRN	?BlKdComSendPacket@@YIEGPBXG0G@Z:PROC		; BlKdComSendPacket
EXTRN	?BlKdComPort@@3EA:BYTE				; BlKdComPort
EXTRN	?BlRtlZeroMemory@@YIXPAXK@Z:PROC		; BlRtlZeroMemory
EXTRN	?BlRtlStringLength@@YIKPBD@Z:PROC		; BlRtlStringLength
; Function compile flags: /Odsp
;	COMDAT ?BlKdPrintString@@YIEPBD@Z
_TEXT	SEGMENT
_String$ = -24						; size = 4
_Packet$ = -20						; size = 16
_StringLength$ = -4					; size = 4
?BlKdPrintString@@YIEPBD@Z PROC				; BlKdPrintString, COMDAT
; _String$ = ecx

; 102  : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 18	 sub	 esp, 24			; 00000018H
  00006	89 4d e8	 mov	 DWORD PTR _String$[ebp], ecx

; 103  :     KD_DEBUG_IO Packet;
; 104  :     UINT32 StringLength;
; 105  : 
; 106  :     StringLength = BlRtlStringLength(String);

  00009	8b 4d e8	 mov	 ecx, DWORD PTR _String$[ebp]
  0000c	e8 00 00 00 00	 call	 ?BlRtlStringLength@@YIKPBD@Z ; BlRtlStringLength
  00011	89 45 fc	 mov	 DWORD PTR _StringLength$[ebp], eax

; 107  : 
; 108  :     if (StringLength >= 0xFFFF) {

  00014	81 7d fc ff ff
	00 00		 cmp	 DWORD PTR _StringLength$[ebp], 65535 ; 0000ffffH
  0001b	72 04		 jb	 SHORT $LN4@BlKdPrintS

; 109  : 
; 110  :         return FALSE;

  0001d	32 c0		 xor	 al, al
  0001f	eb 62		 jmp	 SHORT $LN5@BlKdPrintS
$LN4@BlKdPrintS:

; 111  :     }
; 112  : 
; 113  :     BlRtlZeroMemory(&Packet, sizeof(Packet));

  00021	6a 10		 push	 16			; 00000010H
  00023	5a		 pop	 edx
  00024	8d 4d ec	 lea	 ecx, DWORD PTR _Packet$[ebp]
  00027	e8 00 00 00 00	 call	 ?BlRtlZeroMemory@@YIXPAXK@Z ; BlRtlZeroMemory

; 114  : 
; 115  :     Packet.ApiNumber = KD_API_PRINT_STRING;

  0002c	c7 45 ec 30 32
	00 00		 mov	 DWORD PTR _Packet$[ebp], 12848 ; 00003230H

; 116  :     Packet.u1.PrintString.LengthOfString = StringLength;

  00033	8b 45 fc	 mov	 eax, DWORD PTR _StringLength$[ebp]
  00036	89 45 f4	 mov	 DWORD PTR _Packet$[ebp+8], eax

; 117  : 
; 118  :     if (BlKdComPort != 0) {

  00039	0f b6 05 00 00
	00 00		 movzx	 eax, BYTE PTR ?BlKdComPort@@3EA ; BlKdComPort
  00040	85 c0		 test	 eax, eax
  00042	74 1b		 je	 SHORT $LN3@BlKdPrintS

; 119  : 
; 120  :         return BlKdComSendPacket(KD_PACKET_TYPE_KD_DEBUG_IO,
; 121  :                                  &Packet,
; 122  :                                  sizeof(Packet),
; 123  :                                  String,
; 124  :                                  (UINT16) StringLength + 1);

  00044	0f b7 45 fc	 movzx	 eax, WORD PTR _StringLength$[ebp]
  00048	40		 inc	 eax
  00049	50		 push	 eax
  0004a	ff 75 e8	 push	 DWORD PTR _String$[ebp]
  0004d	6a 10		 push	 16			; 00000010H
  0004f	8d 55 ec	 lea	 edx, DWORD PTR _Packet$[ebp]
  00052	66 b9 03 00	 mov	 cx, 3
  00056	e8 00 00 00 00	 call	 ?BlKdComSendPacket@@YIEGPBXG0G@Z ; BlKdComSendPacket
  0005b	eb 26		 jmp	 SHORT $LN5@BlKdPrintS
  0005d	eb 22		 jmp	 SHORT $LN2@BlKdPrintS
$LN3@BlKdPrintS:

; 125  : 
; 126  :     }
; 127  :     else if (BlPciOhci1394BaseAddress != 0) {

  0005f	83 3d 00 00 00
	00 00		 cmp	 DWORD PTR ?BlPciOhci1394BaseAddress@@3KA, 0 ; BlPciOhci1394BaseAddress
  00066	74 19		 je	 SHORT $LN2@BlKdPrintS

; 128  : 
; 129  :         return BlKd1394SendPacket(KD_PACKET_TYPE_KD_DEBUG_IO,
; 130  :                                   &Packet,
; 131  :                                   sizeof(Packet),
; 132  :                                   String,
; 133  :                                   (UINT16) StringLength + 1);

  00068	0f b7 45 fc	 movzx	 eax, WORD PTR _StringLength$[ebp]
  0006c	40		 inc	 eax
  0006d	50		 push	 eax
  0006e	ff 75 e8	 push	 DWORD PTR _String$[ebp]
  00071	6a 10		 push	 16			; 00000010H
  00073	8d 55 ec	 lea	 edx, DWORD PTR _Packet$[ebp]
  00076	66 b9 03 00	 mov	 cx, 3
  0007a	e8 00 00 00 00	 call	 ?BlKd1394SendPacket@@YIEGPBXG0G@Z ; BlKd1394SendPacket
  0007f	eb 02		 jmp	 SHORT $LN5@BlKdPrintS
$LN2@BlKdPrintS:

; 134  : 
; 135  :     }
; 136  : 
; 137  :     return FALSE;

  00081	32 c0		 xor	 al, al
$LN5@BlKdPrintS:

; 138  : }

  00083	c9		 leave
  00084	c3		 ret	 0
?BlKdPrintString@@YIEPBD@Z ENDP				; BlKdPrintString
_TEXT	ENDS
PUBLIC	?BlKdPrintf@@YAEPBDZZ				; BlKdPrintf
EXTRN	?BlRtlFormatString@@YIEPADKPBD0@Z:PROC		; BlRtlFormatString
; Function compile flags: /Odsp
;	COMDAT ?BlKdPrintf@@YAEPBDZZ
_TEXT	SEGMENT
_Buffer$ = -4104					; size = 4096
_ArgumentList$ = -4					; size = 4
_Format$ = 8						; size = 4
?BlKdPrintf@@YAEPBDZZ PROC				; BlKdPrintf, COMDAT

; 165  : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	81 ec 08 10 00
	00		 sub	 esp, 4104		; 00001008H

; 166  :     va_list ArgumentList;
; 167  :     CHAR Buffer[4096];
; 168  : 
; 169  :     va_start(ArgumentList, Format);

  00009	8d 45 0c	 lea	 eax, DWORD PTR _Format$[ebp+4]
  0000c	89 45 fc	 mov	 DWORD PTR _ArgumentList$[ebp], eax

; 170  : 
; 171  :     if (BlRtlFormatString(Buffer,
; 172  :                           sizeof(Buffer),
; 173  :                           Format,
; 174  :                           ArgumentList) == FALSE) {

  0000f	ff 75 fc	 push	 DWORD PTR _ArgumentList$[ebp]
  00012	ff 75 08	 push	 DWORD PTR _Format$[ebp]
  00015	ba 00 10 00 00	 mov	 edx, 4096		; 00001000H
  0001a	8d 8d f8 ef ff
	ff		 lea	 ecx, DWORD PTR _Buffer$[ebp]
  00020	e8 00 00 00 00	 call	 ?BlRtlFormatString@@YIEPADKPBD0@Z ; BlRtlFormatString
  00025	0f b6 c0	 movzx	 eax, al
  00028	85 c0		 test	 eax, eax
  0002a	75 04		 jne	 SHORT $LN1@BlKdPrintf

; 175  : 
; 176  :         return FALSE;

  0002c	32 c0		 xor	 al, al
  0002e	eb 0d		 jmp	 SHORT $LN2@BlKdPrintf
$LN1@BlKdPrintf:

; 177  :     }
; 178  : 
; 179  :     BlKdPrintString(Buffer);

  00030	8d 8d f8 ef ff
	ff		 lea	 ecx, DWORD PTR _Buffer$[ebp]
  00036	e8 00 00 00 00	 call	 ?BlKdPrintString@@YIEPBD@Z ; BlKdPrintString

; 180  : 
; 181  :     return TRUE;

  0003b	b0 01		 mov	 al, 1
$LN2@BlKdPrintf:

; 182  : }

  0003d	c9		 leave
  0003e	c3		 ret	 0
?BlKdPrintf@@YAEPBDZZ ENDP				; BlKdPrintf
_TEXT	ENDS
PUBLIC	?BlKdInitialize@@YIXXZ				; BlKdInitialize
EXTRN	?BlKd1394Connect@@YIEXZ:PROC			; BlKd1394Connect
EXTRN	?BlKdComConnect@@YIEXZ:PROC			; BlKdComConnect
; Function compile flags: /Odsp
;	COMDAT ?BlKdInitialize@@YIXXZ
_TEXT	SEGMENT
?BlKdInitialize@@YIXXZ PROC				; BlKdInitialize, COMDAT

; 197  : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp

; 198  :     //
; 199  :     // Try serial first.
; 200  :     //
; 201  : 
; 202  :     if (BlKdComConnect() != FALSE) {

  00003	e8 00 00 00 00	 call	 ?BlKdComConnect@@YIEXZ	; BlKdComConnect
  00008	0f b6 c0	 movzx	 eax, al
  0000b	85 c0		 test	 eax, eax
  0000d	74 02		 je	 SHORT $LN2@BlKdInitia

; 203  : 
; 204  : #if KD_VERBOSE
; 205  : 
; 206  :         BlVideoPrintf("KD: Connected to COM%u\n", BlKdComPort);
; 207  : 
; 208  : #endif
; 209  : 
; 210  :         return;

  0000f	eb 05		 jmp	 SHORT $LN3@BlKdInitia
$LN2@BlKdInitia:

; 211  :     }
; 212  : 
; 213  :     //
; 214  :     // Try the 1394 transport next.
; 215  :     //
; 216  : 
; 217  :     if (BlKd1394Connect() != FALSE) {

  00011	e8 00 00 00 00	 call	 ?BlKd1394Connect@@YIEXZ	; BlKd1394Connect
$LN3@BlKdInitia:

; 218  : 
; 219  : #if KD_VERBOSE
; 220  : 
; 221  :         BlVideoPrintf("KD: Connected to 1394:%u\n", 0);
; 222  : 
; 223  : #endif
; 224  : 
; 225  :         return;
; 226  :     }
; 227  : 
; 228  :     return;
; 229  : }

  00016	5d		 pop	 ebp
  00017	c3		 ret	 0
?BlKdInitialize@@YIXXZ ENDP				; BlKdInitialize
_TEXT	ENDS
END
